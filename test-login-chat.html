<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Chat Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
        input, button {
            padding: 8px;
            margin: 5px 0;
            font-size: 14px;
        }
        input[type="text"], input[type="password"] {
            width: 250px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 20px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
        }
        .message.sent {
            background: #e3f2fd;
            text-align: right;
        }
        .message.received {
            background: #fff3cd;
        }
        .message img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 5px;
            margin-top: 5px;
            cursor: pointer;
        }
        .upload-section {
            margin-top: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        .upload-status {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <h1>Login & Real-time Chat Test</h1>

    <!-- Auth Section -->
    <div id="authSection" class="section">
        <h2>ì¸ì¦</h2>
        <div id="authStatus" class="status info">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>

        <div>
            <h3>íšŒì›ê°€ì…</h3>
            <input type="text" id="regUsername" placeholder="ì‚¬ìš©ìëª… (ìµœì†Œ 3ì)"><br>
            <input type="password" id="regPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ (ìµœì†Œ 6ì)"><br>
            <button onclick="register()">íšŒì›ê°€ì…</button>
        </div>

        <div style="margin-top: 20px;">
            <h3>ë¡œê·¸ì¸</h3>
            <input type="text" id="loginUsername" placeholder="ì‚¬ìš©ìëª…"><br>
            <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸"><br>
            <button onclick="login()">ë¡œê·¸ì¸</button>
        </div>

        <div style="margin-top: 10px;">
            <small>í˜„ì¬ í† í°: <span id="tokenDisplay">ì—†ìŒ</span></small><br>
            <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <!-- Chat Section -->
    <div id="chatSection" class="section hidden">
        <h2>ì±„íŒ…</h2>
        <div id="chatStatus" class="status info">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

        <div>
            <label>Room ID: <input type="text" id="roomId" value="demo-room-1"></label><br>
            <button onclick="connectChat()">ì±„íŒ… ì—°ê²°</button>
            <button onclick="disconnectChat()">ì—°ê²° í•´ì œ</button>
        </div>

        <div style="margin-top: 15px;">
            <input type="text" id="messageText" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="width: 70%;">
            <button onclick="sendMessage()">ì „ì†¡</button>
        </div>

        <div class="upload-section">
            <h4>ì´ë¯¸ì§€ ì—…ë¡œë“œ</h4>
            <input type="file" id="fileInput" accept="image/*">
            <button onclick="uploadAndSendImage()">ì´ë¯¸ì§€ ì „ì†¡</button>
            <div id="uploadStatus" class="upload-status"></div>
        </div>

        <div style="margin-top: 15px;">
            <h3>ë©”ì‹œì§€</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://localhost:8443';
        let socket = null;
        let currentUser = null;

        // Initialize
        window.onload = function() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            if (token && username) {
                currentUser = { token, username };
                updateAuthUI(true);
            }
        };

        function updateStatus(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = 'status ' + type;
        }

        function updateAuthUI(loggedIn) {
            if (loggedIn) {
                document.getElementById('tokenDisplay').textContent =
                    currentUser.token.substring(0, 20) + '...';
                document.getElementById('authSection').querySelector('.status').textContent =
                    `ë¡œê·¸ì¸ë¨: ${currentUser.username}`;
                document.getElementById('authSection').querySelector('.status').className = 'status success';
                document.getElementById('chatSection').classList.remove('hidden');
            } else {
                document.getElementById('tokenDisplay').textContent = 'ì—†ìŒ';
                updateStatus('authStatus', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'info');
                document.getElementById('chatSection').classList.add('hidden');
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }
            }
        }

        async function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;

            if (!username || !password) {
                updateStatus('authStatus', 'ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨');
                }

                const data = await response.json();
                currentUser = { token: data.token, username: data.username };
                localStorage.setItem('token', data.token);
                localStorage.setItem('username', data.username);

                updateAuthUI(true);
                updateStatus('authStatus', `íšŒì›ê°€ì… ì„±ê³µ! (${data.username})`, 'success');

                // Clear form
                document.getElementById('regUsername').value = '';
                document.getElementById('regPassword').value = '';
            } catch (error) {
                updateStatus('authStatus', `íšŒì›ê°€ì… ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                updateStatus('authStatus', 'ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('ì˜ëª»ëœ ì‚¬ìš©ìëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸');
                    }
                    const error = await response.json();
                    throw new Error(error.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
                }

                const data = await response.json();
                currentUser = { token: data.token, username: data.username };
                localStorage.setItem('token', data.token);
                localStorage.setItem('username', data.username);

                updateAuthUI(true);
                updateStatus('authStatus', `ë¡œê·¸ì¸ ì„±ê³µ! (${data.username})`, 'success');

                // Clear form
                document.getElementById('loginPassword').value = '';
            } catch (error) {
                updateStatus('authStatus', `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            updateAuthUI(false);
            updateStatus('authStatus', 'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        }

        function addMessage(text, type = 'info', imageUrl = null) {
            const messagesDiv = document.getElementById('messages');
            const msg = document.createElement('div');
            msg.className = 'message ' + type;

            const timestamp = document.createElement('div');
            timestamp.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            msg.appendChild(timestamp);

            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = 'Uploaded image';
                img.onclick = () => window.open(imageUrl, '_blank');
                msg.appendChild(img);
            }

            messagesDiv.appendChild(msg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function connectChat() {
            if (!currentUser || !currentUser.token) {
                updateStatus('chatStatus', 'ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”', 'error');
                return;
            }

            if (socket && socket.connected) {
                updateStatus('chatStatus', 'ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤', 'info');
                return;
            }

            const roomId = document.getElementById('roomId').value;
            updateStatus('chatStatus', 'ì—°ê²° ì¤‘...', 'info');

            socket = io(API_URL, {
                auth: { token: currentUser.token },
                transports: ['websocket', 'polling'],
                rejectUnauthorized: false
            });

            socket.on('connect', () => {
                updateStatus('chatStatus', 'âœ… WebSocket ì—°ê²° ì„±ê³µ!', 'success');
                addMessage('ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤');

                socket.emit('join', { roomId });
                addMessage(`ë°© ${roomId}ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤`);
            });

            socket.on('disconnect', () => {
                updateStatus('chatStatus', 'ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤', 'error');
                addMessage('ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
            });

            socket.on('error', (error) => {
                updateStatus('chatStatus', 'ì—ëŸ¬: ' + error, 'error');
                addMessage('ì—ëŸ¬ ë°œìƒ: ' + error);
            });

            socket.on('message', (data) => {
                const isMe = data.senderId === currentUser.username;
                const senderName = isMe ? 'ë‚˜' : data.senderId;

                if (data.type === 'image') {
                    addMessage(`${senderName}: [ì´ë¯¸ì§€]`, isMe ? 'sent' : 'received', data.fileUrl);
                } else {
                    addMessage(`${senderName}: ${data.text || JSON.stringify(data)}`, isMe ? 'sent' : 'received');
                }
            });

            socket.on('ack', (data) => {
                addMessage(`âœ“ ë©”ì‹œì§€ ì „ì†¡ í™•ì¸`);
            });

            socket.on('typing', (data) => {
                addMessage(`âŒ¨ï¸ ${data.userId} is typing...`);
            });

            socket.on('presence', (data) => {
                addMessage(`ğŸ‘¤ ${data.userId} ${data.state === 'join' ? 'joined' : 'left'}`);
            });
        }

        function disconnectChat() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateStatus('chatStatus', 'ì—°ê²° í•´ì œë¨', 'info');
            }
        }

        function sendMessage() {
            if (!socket || !socket.connected) {
                updateStatus('chatStatus', 'ë¨¼ì € ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'error');
                return;
            }

            const roomId = document.getElementById('roomId').value;
            const text = document.getElementById('messageText').value;

            if (!text.trim()) return;

            const clientMessageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).slice(2);

            socket.emit('message', {
                roomId,
                clientMessageId,
                type: 'text',
                text
            });

            document.getElementById('messageText').value = '';
        }

        async function uploadAndSendImage() {
            if (!socket || !socket.connected) {
                updateStatus('chatStatus', 'ë¨¼ì € ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'error');
                return;
            }

            if (!currentUser || !currentUser.token) {
                updateStatus('chatStatus', 'ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”', 'error');
                return;
            }

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                document.getElementById('uploadStatus').textContent = 'íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”';
                return;
            }

            try {
                // Step 1: Get presigned URL
                document.getElementById('uploadStatus').textContent = 'Presigned URL ìš”ì²­ ì¤‘...';

                const presignedResponse = await fetch(`${API_URL}/storage/presigned-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        fileName: file.name,
                        fileType: file.type
                    })
                });

                if (!presignedResponse.ok) {
                    throw new Error('Presigned URL ìƒì„± ì‹¤íŒ¨');
                }

                const { uploadUrl, fileUrl, key } = await presignedResponse.json();

                // Step 2: Upload file to MinIO
                document.getElementById('uploadStatus').textContent = 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...';

                const uploadResponse = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': file.type
                    },
                    body: file
                });

                if (!uploadResponse.ok) {
                    throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                // Step 3: Send message with image
                document.getElementById('uploadStatus').textContent = 'ë©”ì‹œì§€ ì „ì†¡ ì¤‘...';

                const roomId = document.getElementById('roomId').value;
                const clientMessageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).slice(2);

                socket.emit('message', {
                    roomId,
                    clientMessageId,
                    type: 'image',
                    fileUrl: fileUrl,
                    fileName: file.name,
                    fileType: file.type
                });

                document.getElementById('uploadStatus').textContent = 'âœ“ ì´ë¯¸ì§€ ì „ì†¡ ì™„ë£Œ!';
                fileInput.value = ''; // Clear file input

                setTimeout(() => {
                    document.getElementById('uploadStatus').textContent = '';
                }, 3000);

            } catch (error) {
                document.getElementById('uploadStatus').textContent = `âœ— ì—ëŸ¬: ${error.message}`;
                console.error('Upload error:', error);
            }
        }

        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('messageText').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
