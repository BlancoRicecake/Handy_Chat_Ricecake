# ===================================================================
# MVP Environment Configuration Template
# ===================================================================
# Minimal configuration for EC2 single-instance deployment
# Target cost: $15-30/month
#
# Copy this file to .env.mvp and fill in actual values
# NEVER commit .env.mvp to version control!
#
# Guide: docs/deployment/MVP_DEPLOYMENT_GUIDE.md
# ===================================================================

# Server Configuration
NODE_ENV=production
PORT=3000
HOST=0.0.0.0
TRUST_PROXY=1

# ===================================================================
# Database - Local MongoDB Container
# ===================================================================
# MongoDB runs as a container in docker-compose.mvp.yml
# No external service required!
MONGO_URI=mongodb://mongo:27017/chatdb

# Optional: If you enabled MongoDB authentication in docker-compose.mvp.yml
# MONGO_URI=mongodb://admin:password@mongo:27017/chatdb?authSource=admin

# ===================================================================
# Redis - Local Redis Container
# ===================================================================
# Redis runs as a container in docker-compose.mvp.yml
# No external service required!
REDIS_URL=redis://redis:6379/0

# Optional: If you enabled Redis password in docker-compose.mvp.yml
# REDIS_URL=redis://:yourpassword@redis:6379/0

# ===================================================================
# Security - JWT (File-based, no AWS Secrets Manager)
# ===================================================================
# Phase 1 Configuration (Legacy 7-day tokens)
# Generate strong secret: openssl rand -base64 64
#
# ⚠️ IMPORTANT: Change this to a strong random secret!
JWT_SECRET_CURRENT=CHANGE_THIS_TO_A_STRONG_RANDOM_SECRET_MINIMUM_64_CHARS_FOR_PRODUCTION
JWT_SECRET_PREVIOUS=

# Token Expiry (Phase 1 - Simple tokens)
ACCESS_TOKEN_EXPIRY=7d
REFRESH_TOKEN_EXPIRY=7d
JWT_CLOCK_TOLERANCE=60

# Feature Flags (Phase 1 - Disabled for MVP simplicity)
USE_ROTATED_JWT=false
ENABLE_REFRESH_TOKEN=false
ENFORCE_SINGLE_SESSION=false

# AWS Secrets Manager (Disabled for MVP)
USE_AWS_SECRETS=false
SECRET_CACHE_TTL=300000
AWS_SECRETS_FAIL_OPEN=false

# ===================================================================
# Security - CORS
# ===================================================================
# ⚠️ CRITICAL: Set to your actual domain
# Examples:
#   Local testing: http://localhost:3000
#   Production: https://yourdomain.com,https://www.yourdomain.com
CORS_ORIGIN=https://yourdomain.com

# ===================================================================
# Logging
# ===================================================================
LOG_LEVEL=info

# ===================================================================
# Chat Server Proxy
# ===================================================================
# Proxy target for /chat-api/* requests to avoid Mixed Content issues
# This allows the frontend to make requests through the main server
# instead of directly to the chat server (HTTP -> HTTPS)
# Default: http://16.176.147.141 (if not set)
CHAT_SERVER_URL=http://16.176.147.141

# ===================================================================
# S3 Storage (DISABLED for MVP)
# ===================================================================
# File uploads will use local filesystem or be disabled
# Enable S3 later when scaling up
USE_S3=false

# If you want to enable S3 later, uncomment and configure:
# S3_ENDPOINT=
# S3_BUCKET_NAME=mvp-chat-files
# S3_ACCESS_KEY=AKIA...
# S3_SECRET_KEY=...
# S3_REGION=us-east-1
# S3_USE_PATH_STYLE=false

# ===================================================================
# MVP Deployment Checklist
# ===================================================================
# Before deploying, ensure:
#
# 1. EC2 Instance:
#    □ t3.small or t3.medium launched
#    □ Docker and Docker Compose installed
#    □ Security group: 80, 443 open to 0.0.0.0/0
#    □ SSH (22) open to your IP only
#
# 2. Domain Setup:
#    □ Domain points to EC2 Elastic IP
#    □ Caddyfile updated with your domain
#    □ CORS_ORIGIN updated above
#
# 3. Security:
#    □ JWT_SECRET_CURRENT changed from default (64+ chars)
#    □ File permissions: chmod 600 .env.mvp
#    □ Never commit .env.mvp to git
#
# 4. Optional Enhancements:
#    □ Enable MongoDB authentication (docker-compose.mvp.yml)
#    □ Enable Redis password (docker-compose.mvp.yml)
#    □ Setup automatic backups (cron job)
#
# ===================================================================

# ===================================================================
# Cost Breakdown (MVP)
# ===================================================================
# EC2 t3.small (On-Demand):        $15/month
# EC2 t3.medium (On-Demand):       $30/month
# EBS 20GB:                        $2/month
# Elastic IP (attached):           $0/month
# Data transfer (first 100GB):     $0/month
# ------------------------------------------------------
# Total:                           $17-32/month
#
# Cost savings:
# - 1-year Reserved Instance: Save 30-40%
# - 3-year Reserved Instance: Save 50-60%
#
# Compare to full production ($100-110/month):
# MVP saves ~$70-90/month (70-85% cost reduction)
# ===================================================================

# ===================================================================
# When to Scale Up
# ===================================================================
# Consider upgrading when you experience:
#
# Stage 2 (MongoDB Atlas):
#   - Database size > 5GB
#   - Need automatic backups
#   - Need replica sets
#   - Cost: +$50/month
#
# Stage 3 (ElastiCache Redis):
#   - High cache hit rate requirements
#   - Need Redis Cluster
#   - Cost: +$15/month
#
# Stage 4 (Full Production):
#   - DAU > 5000
#   - Need CI/CD automation
#   - Enterprise requirements
#   - Cost: Full production stack
#
# See: docs/deployment/SCALING_ROADMAP.md
# ===================================================================

# ===================================================================
# Backup Strategy (MVP)
# ===================================================================
# Automated backup script (run daily via cron):
#
# #!/bin/bash
# BACKUP_DIR=/opt/chat-app/backups
# TIMESTAMP=$(date +%Y%m%d_%H%M%S)
#
# # Backup MongoDB
# docker exec $(docker ps -qf "name=mongo") \
#   mongodump --out=/tmp/backup
#
# docker cp $(docker ps -qf "name=mongo"):/tmp/backup \
#   $BACKUP_DIR/mongo_$TIMESTAMP
#
# # Backup Redis (AOF file)
# docker exec $(docker ps -qf "name=redis") \
#   redis-cli BGSAVE
#
# # Keep last 7 days
# find $BACKUP_DIR -mtime +7 -delete
#
# Add to crontab: 0 2 * * * /opt/chat-app/backup.sh
# ===================================================================

# ===================================================================
# Monitoring (MVP)
# ===================================================================
# Basic monitoring without CloudWatch:
#
# 1. Disk space:
#    df -h
#
# 2. Memory usage:
#    free -h
#
# 3. Container stats:
#    docker stats
#
# 4. Application logs:
#    docker-compose -f docker-compose.mvp.yml logs -f api
#
# 5. MongoDB slow queries:
#    docker exec -it $(docker ps -qf "name=mongo") mongosh
#    > use chatdb
#    > db.setProfilingLevel(1, { slowms: 100 })
#    > db.system.profile.find().sort({ts:-1}).limit(5)
#
# Setup alerts when:
#   - Disk usage > 80%
#   - Memory usage > 85%
#   - CPU usage > 90% (sustained)
# ===================================================================
