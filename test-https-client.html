<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTPS WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        input, button { padding: 8px; margin: 5px 0; }
        #messages { border: 1px solid #ccc; padding: 10px; min-height: 200px; max-height: 400px; overflow-y: auto; }
        .message { margin: 5px 0; padding: 5px; background: #f8f9fa; }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <h1>ë¡œì»¬ ìŠ¤í…Œì´ì§• ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸</h1>

    <div id="status" class="status info">
        ì—°ê²° ëŒ€ê¸° ì¤‘...
    </div>

    <div>
        <h3>ì„¤ì •</h3>
        <label>Room ID: <input type="text" id="roomId" value="demo-room-1"></label><br>
        <label>JWT Token: <input type="text" id="token" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyMSIsImlhdCI6MTc2MjU4NzcyMywiZXhwIjoxNzYzMTkyNTIzfQ.MslCW2a62wlqaGYoVzE-mkCL5KrRqAVc7TNZdXfYy-I"></label><br>
        <button onclick="connect()">ì—°ê²°</button>
        <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
    </div>

    <div>
        <h3>ë©”ì‹œì§€ ì „ì†¡</h3>
        <input type="text" id="messageText" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="width: 70%;">
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <div>
        <h3>ë©”ì‹œì§€</h3>
        <div id="messages"></div>
    </div>

    <div>
        <h3>ë³´ì•ˆ ê²€ì¦</h3>
        <ul id="securityChecks">
            <li>HTTPS ì—°ê²°: <span id="httpsCheck">í™•ì¸ ì¤‘...</span></li>
            <li>WSS (Secure WebSocket): <span id="wssCheck">í™•ì¸ ì¤‘...</span></li>
            <li>ë³´ì•ˆ í—¤ë”: <span id="headersCheck">í™•ì¸ ì¤‘...</span></li>
        </ul>
    </div>

    <script>
        let socket = null;
        const API_URL = 'https://localhost:8443';

        // HTTPS í™•ì¸
        if (window.location.protocol === 'file:') {
            document.getElementById('httpsCheck').textContent = 'íŒŒì¼ í”„ë¡œí† ì½œ (ë¡œì»¬ íŒŒì¼)';
        } else if (window.location.protocol === 'https:') {
            document.getElementById('httpsCheck').textContent = 'âœ… í™œì„±í™”ë¨';
        } else {
            document.getElementById('httpsCheck').textContent = 'âŒ HTTP ì‚¬ìš© ì¤‘';
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        function addMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const msg = document.createElement('div');
            msg.className = 'message';
            msg.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            messagesDiv.appendChild(msg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function checkSecurityHeaders() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const headers = response.headers;

                const hasCSP = headers.has('content-security-policy');
                const hasHSTS = headers.has('strict-transport-security');
                const hasXFrame = headers.has('x-frame-options');

                if (hasCSP && hasHSTS && hasXFrame) {
                    document.getElementById('headersCheck').textContent = 'âœ… ì ìš©ë¨ (CSP, HSTS, X-Frame-Options)';
                } else {
                    document.getElementById('headersCheck').textContent = 'âš ï¸ ì¼ë¶€ í—¤ë” ëˆ„ë½';
                }
            } catch (error) {
                document.getElementById('headersCheck').textContent = 'âŒ í™•ì¸ ì‹¤íŒ¨: ' + error.message;
            }
        }

        function connect() {
            if (socket && socket.connected) {
                updateStatus('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤', 'info');
                return;
            }

            const roomId = document.getElementById('roomId').value;
            const token = document.getElementById('token').value;

            updateStatus('ì—°ê²° ì¤‘...', 'info');

            socket = io(API_URL, {
                auth: { token },
                transports: ['websocket', 'polling'],
                rejectUnauthorized: false // ìì²´ ì„œëª… ì¸ì¦ì„œë¥¼ ìœ„í•´
            });

            socket.on('connect', () => {
                updateStatus('âœ… WebSocket ì—°ê²° ì„±ê³µ!', 'success');
                document.getElementById('wssCheck').textContent = 'âœ… WSS ì—°ê²° í™œì„±í™”';
                addMessage('ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤');

                socket.emit('join', { roomId });
                addMessage(`ë°© ${roomId}ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤`);
            });

            socket.on('disconnect', () => {
                updateStatus('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤', 'error');
                document.getElementById('wssCheck').textContent = 'âŒ ì—°ê²° ëŠê¹€';
                addMessage('ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
            });

            socket.on('error', (error) => {
                updateStatus('ì—ëŸ¬: ' + error, 'error');
                addMessage('ì—ëŸ¬ ë°œìƒ: ' + error);
            });

            socket.on('message', (data) => {
                addMessage(`ğŸ“© ìˆ˜ì‹ : ${data.text || JSON.stringify(data)}`);
            });

            socket.on('ack', (data) => {
                addMessage(`âœ“ ACK: ${data.clientMessageId}`);
            });

            socket.on('typing', (data) => {
                addMessage(`âŒ¨ï¸ ${data.userId} is typing...`);
            });

            socket.on('presence', (data) => {
                addMessage(`ğŸ‘¤ ${data.userId} ${data.state === 'join' ? 'joined' : 'left'}`);
            });

            // ë³´ì•ˆ í—¤ë” í™•ì¸
            checkSecurityHeaders();
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateStatus('ì—°ê²° í•´ì œë¨', 'info');
            }
        }

        function sendMessage() {
            if (!socket || !socket.connected) {
                updateStatus('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”', 'error');
                return;
            }

            const roomId = document.getElementById('roomId').value;
            const text = document.getElementById('messageText').value;

            if (!text.trim()) return;

            const clientMessageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).slice(2);

            socket.emit('message', {
                roomId,
                clientMessageId,
                type: 'text',
                text
            });

            addMessage(`ğŸ“¤ ì „ì†¡: ${text}`);
            document.getElementById('messageText').value = '';
        }

        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('messageText').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
