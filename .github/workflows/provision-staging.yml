name: Provision Staging Instance

on:
  workflow_dispatch:

jobs:
  provision:
    name: Create Staging EC2 Instance
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Import SSH key pair
        id: keypair
        run: |
          KEY_PAIR_NAME="handy-staging-key"

          # Check if key pair already exists
          EXISTING=$(aws ec2 describe-key-pairs --key-names "$KEY_PAIR_NAME" 2>/dev/null || true)
          if echo "$EXISTING" | grep -q "$KEY_PAIR_NAME"; then
            echo "Key pair '$KEY_PAIR_NAME' already exists"
          else
            echo "Importing key pair from EC2_SSH_PRIVATE_KEY secret..."
            # Extract public key from private key
            echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > /tmp/privkey.pem
            chmod 600 /tmp/privkey.pem
            ssh-keygen -y -f /tmp/privkey.pem > /tmp/pubkey.pub
            rm /tmp/privkey.pem

            aws ec2 import-key-pair \
              --key-name "$KEY_PAIR_NAME" \
              --public-key-material fileb:///tmp/pubkey.pub
            rm /tmp/pubkey.pub
            echo "Key pair imported successfully"
          fi

          echo "key_name=$KEY_PAIR_NAME" >> $GITHUB_OUTPUT

      - name: Discover infrastructure
        id: infra
        run: |
          echo "=== Getting default VPC ==="
          VPC_ID=$(aws ec2 describe-vpcs --filters "Name=is-default,Values=true" \
            --query 'Vpcs[0].VpcId' --output text)
          echo "Default VPC: $VPC_ID"

          echo ""
          echo "=== Getting subnet with public IP auto-assign ==="
          SUBNET_ID=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=$VPC_ID" "Name=map-public-ip-on-launch,Values=true" \
            --query 'Subnets[0].SubnetId' --output text)

          if [ "$SUBNET_ID" = "None" ] || [ -z "$SUBNET_ID" ]; then
            echo "No subnet with auto-assign public IP, using first subnet"
            SUBNET_ID=$(aws ec2 describe-subnets \
              --filters "Name=vpc-id,Values=$VPC_ID" \
              --query 'Subnets[0].SubnetId' --output text)
          fi
          echo "Subnet: $SUBNET_ID"

          echo ""
          echo "=== Setting up security group ==="
          SG_NAME="handy-staging-sg"
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=vpc-id,Values=$VPC_ID" "Name=group-name,Values=$SG_NAME" \
            --query 'SecurityGroups[0].GroupId' --output text 2>/dev/null || echo "None")

          if [ "$SG_ID" = "None" ] || [ -z "$SG_ID" ]; then
            echo "Creating security group..."
            SG_ID=$(aws ec2 create-security-group \
              --group-name "$SG_NAME" \
              --description "Handy Chat Staging - SSH, HTTP, HTTPS" \
              --vpc-id "$VPC_ID" \
              --query 'GroupId' --output text)

            aws ec2 authorize-security-group-ingress --group-id "$SG_ID" \
              --ip-permissions \
              '[{"IpProtocol":"tcp","FromPort":22,"ToPort":22,"IpRanges":[{"CidrIp":"0.0.0.0/0"}]},{"IpProtocol":"tcp","FromPort":80,"ToPort":80,"IpRanges":[{"CidrIp":"0.0.0.0/0"}]},{"IpProtocol":"tcp","FromPort":443,"ToPort":443,"IpRanges":[{"CidrIp":"0.0.0.0/0"}]}]'
            echo "Security group created with SSH/HTTP/HTTPS rules"
          else
            echo "Security group already exists: $SG_ID"
          fi
          echo "Security Group: $SG_ID"

          echo ""
          echo "=== Getting latest AL2023 ARM64 AMI ==="
          AMI_ID=$(aws ec2 describe-images \
            --owners amazon \
            --filters "Name=name,Values=al2023-ami-2023*-kernel-*-arm64" "Name=state,Values=available" \
            --query 'sort_by(Images, &CreationDate)[-1].ImageId' --output text)
          echo "AMI: $AMI_ID"

          echo "vpc_id=$VPC_ID" >> $GITHUB_OUTPUT
          echo "subnet_id=$SUBNET_ID" >> $GITHUB_OUTPUT
          echo "sg_id=$SG_ID" >> $GITHUB_OUTPUT
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT

      - name: Create staging instance
        id: staging
        run: |
          echo "Creating staging instance..."
          echo "  AMI: ${{ steps.infra.outputs.ami_id }}"
          echo "  Key: ${{ steps.keypair.outputs.key_name }}"
          echo "  SG:  ${{ steps.infra.outputs.sg_id }}"
          echo "  Subnet: ${{ steps.infra.outputs.subnet_id }}"

          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id ${{ steps.infra.outputs.ami_id }} \
            --instance-type t4g.small \
            --key-name ${{ steps.keypair.outputs.key_name }} \
            --security-group-ids ${{ steps.infra.outputs.sg_id }} \
            --subnet-id ${{ steps.infra.outputs.subnet_id }} \
            --associate-public-ip-address \
            --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=handy-chat-staging}]' \
            --block-device-mappings '[{"DeviceName":"/dev/xvda","Ebs":{"VolumeSize":20,"VolumeType":"gp3"}}]' \
            --query 'Instances[0].InstanceId' --output text)

          echo "Instance ID: $INSTANCE_ID"
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

          echo "Waiting for instance to be running..."
          aws ec2 wait instance-running --instance-ids $INSTANCE_ID

          echo "Waiting for status checks..."
          aws ec2 wait instance-status-ok --instance-ids $INSTANCE_ID

          PUBLIC_IP=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID \
            --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)

          echo "instance_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT

      - name: Print staging instance info
        run: |
          echo "============================================"
          echo "  STAGING INSTANCE CREATED SUCCESSFULLY"
          echo "============================================"
          echo ""
          echo "  Instance ID: ${{ steps.staging.outputs.instance_id }}"
          echo "  Public IP:   ${{ steps.staging.outputs.instance_ip }}"
          echo ""
          echo "  Next steps:"
          echo "  1. Add GitHub Secret: STAGING_EC2_HOST = ${{ steps.staging.outputs.instance_ip }}"
          echo "  2. Run CD workflow to deploy"
          echo "============================================"

      - name: Setup staging server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.staging.outputs.instance_ip }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 10m
          script_stop: true
          script: |
            set -euo pipefail

            echo "=== Installing Docker ==="
            sudo dnf update -y
            sudo dnf install -y docker git
            sudo systemctl enable docker
            sudo systemctl start docker
            sudo usermod -aG docker $USER

            echo "=== Installing Docker Compose ==="
            sudo mkdir -p /usr/local/lib/docker/cli-plugins
            sudo curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-aarch64" \
              -o /usr/local/lib/docker/cli-plugins/docker-compose
            sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

            # Symlink for docker-compose command
            sudo ln -sf /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose

            echo "=== Verify installations ==="
            docker --version
            docker-compose --version
            git --version

            echo "=== Setup project directory ==="
            sudo mkdir -p /opt/chat-staging
            sudo chown $USER:$USER /opt/chat-staging

            echo "=== Setup complete ==="
