name: "[Temp] Fix prod .env conflict"

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: Stash .env and pull latest
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 3m
          script: |
            cd /opt/chat-app
            echo "=== Resolve stash pop conflict ==="
            # server/.env는 git에서 삭제됐지만 서버에 필요 — untrack하고 파일 유지
            git rm --cached server/.env 2>/dev/null || true
            git checkout -- . 2>/dev/null || true
            git stash drop 2>/dev/null || true
            git reset HEAD 2>/dev/null || true
            echo "=== Final status ==="
            git status --short
            echo "=== Verify server/.env exists ==="
            ls -la server/.env 2>&1 || echo "server/.env MISSING"
